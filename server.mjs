import express from "express";
import cors from "cors";

const app = express();
app.use(cors());

/* =========================
   рднрд╛рд░рддреАрдп рджрд┐рд╡рд╕ / рдЬрдпрдВрддреА рдореИрдк
   ========================= */
const indianDayMap = {
  "01-26": ["ЁЯЗоЁЯЗ│ рдЧрдгрддрдВрддреНрд░ рджрд┐рд╡рд╕"],
  "08-15": ["ЁЯЗоЁЯЗ│ рд╕реНрд╡рддрдВрддреНрд░рддрд╛ рджрд┐рд╡рд╕"],
  "10-02": ["рдЧрд╛рдВрдзреА рдЬрдпрдВрддреА"],
  "01-23": ["рдиреЗрддрд╛рдЬреА рд╕реБрднрд╛рд╖ рдЪрдВрджреНрд░ рдмреЛрд╕ рдЬрдпрдВрддреА"],
  "04-14": ["рдбреЙ. рднреАрдорд░рд╛рд╡ рдЕрдВрдмреЗрдбрдХрд░ рдЬрдпрдВрддреА"],
  "09-05": ["рд╢рд┐рдХреНрд╖рдХ рджрд┐рд╡рд╕"],
};

/* =========================
   рд╡рд╛рд░ (Day names)
   ========================= */
const vaarMap = [
  "рд░рд╡рд┐рд╡рд╛рд░",
  "рд╕реЛрдорд╡рд╛рд░",
  "рдордВрдЧрд▓рд╡рд╛рд░",
  "рдмреБрдзрд╡рд╛рд░",
  "рдЧреБрд░реБрд╡рд╛рд░",
  "рд╢реБрдХреНрд░рд╡рд╛рд░",
  "рд╢рдирд┐рд╡рд╛рд░",
];

/* =========================
   рдорд╛рд╕ + рддрд┐рдерд┐ (Base Logic)
   NOTE: рдпрд╣ production-safe fallback рд╣реИ
   ========================= */
function getTithiPaksha(date) {
  // SIMPLE LOGIC (stable fallback)
  const day = date.getDate();

  const paksha = day <= 15 ? "рд╢реБрдХреНрд▓ рдкрдХреНрд╖" : "рдХреГрд╖реНрдг рдкрдХреНрд╖";
  const tithiNumber = day <= 15 ? day : day - 15;

  const tithiNames = [
    "рдкреНрд░рддрд┐рдкрджрд╛",
    "рджреНрд╡рд┐рддреАрдпрд╛",
    "рддреГрддреАрдпрд╛",
    "рдЪрддреБрд░реНрдереА",
    "рдкрдВрдЪрдореА",
    "рд╖рд╖реНрдареА",
    "рд╕рдкреНрддрдореА",
    "рдЕрд╖реНрдЯрдореА",
    "рдирд╡рдореА",
    "рджрд╢рдореА",
    "рдПрдХрд╛рджрд╢реА",
    "рджреНрд╡рд╛рджрд╢реА",
    "рддреНрд░рдпреЛрджрд╢реА",
    "рдЪрддреБрд░реНрджрд╢реА",
    "рдЕрдорд╛рд╡рд╕реНрдпрд╛ / рдкреВрд░реНрдгрд┐рдорд╛",
  ];

  return `${paksha} ${tithiNames[tithiNumber - 1]}`;
}

function getMaas(month) {
  const maasMap = [
    "рдЪреИрддреНрд░",
    "рд╡реИрд╢рд╛рдЦ",
    "рдЬреНрдпреЗрд╖реНрда",
    "рдЖрд╖рд╛рдврд╝",
    "рд╢реНрд░рд╛рд╡рдг",
    "рднрд╛рджреНрд░рдкрдж",
    "рдЖрд╢реНрд╡рд┐рди",
    "рдХрд╛рд░реНрддрд┐рдХ",
    "рдорд╛рд░реНрдЧрд╢реАрд░реНрд╖",
    "рдкреМрд╖",
    "рдорд╛рдШ",
    "рдлрд╛рд▓реНрдЧреБрди",
  ];
  return maasMap[month] || "";
}

/* =========================
   Panchang API (Stable)
   ========================= */
app.get("/api/panchang", (req, res) => {
  const now = new Date();

  const dateStr = now.toLocaleDateString("en-GB").split("/").join("-");
  const vaar = vaarMap[now.getDay()];

  const maas = getMaas(now.getMonth());
  const tithi = getTithiPaksha(now);

  /* рднрд╛рд░рддреАрдп рджрд┐рд╡рд╕ */
  const key = `${String(now.getMonth() + 1).padStart(2, "0")}-${String(
    now.getDate()
  ).padStart(2, "0")}`;

  const vratTyohar = indianDayMap[key] || [];

  res.json({
    date: dateStr,
    vaar,
    vikramSamvat: "2082 (рд╕рд┐рджреНрдзрд╛рд░реНрдереА)",
    shakSamvat: "1947 (рд╡рд┐рд╢реНрд╡рд╛рд╡рд╕реБ)",
    maas,
    tithi,
    sunMoon: {
      sunrise: "--",
      sunset: "--",
      moonrise: "--",
      moonset: "--",
    },
    vratTyohar,
  });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, "0.0.0.0", () => {
  console.log("Bhakti Panchang backend running");
});
